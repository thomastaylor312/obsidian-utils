name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-linux:
    name: linux-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - arch: arm64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
    steps:
      - name: Checkout sources
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Install musl toolchain
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y musl-tools
        shell: bash
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          cache-targets: true
      - name: Build binaries
        run: cargo build --release --workspace --target ${{ matrix.target }}
        shell: bash
      - name: Package artifacts
        run: |
          set -euo pipefail
          TARGET="${{ matrix.target }}"
          ARCH="${{ matrix.arch }}"
          rm -rf dist
          mkdir -p dist
          cp "target/$TARGET/release/obsidian-links" dist/
          cp "target/$TARGET/release/obsidian-tags" dist/
          tar -C dist -czf "obsidian-utils-linux-${ARCH}.tar.gz" obsidian-links obsidian-tags
        shell: bash
      - name: Upload artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: obsidian-utils-linux-${{ matrix.arch }}
          path: obsidian-utils-linux-${{ matrix.arch }}.tar.gz

  build-macos-arm64:
    runs-on: macos-14
    steps:
      - name: Checkout sources
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          cache-targets: true
      - name: Build binaries
        run: cargo build --release --workspace
        shell: bash
      - name: Package artifacts
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          cp target/release/obsidian-links dist/
          cp target/release/obsidian-tags dist/
          tar -C dist -czf obsidian-utils-macos-arm64.tar.gz obsidian-links obsidian-tags
        shell: bash
      - name: Upload artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: obsidian-utils-macos-arm64
          path: obsidian-utils-macos-arm64.tar.gz

  build-windows-x86_64:
    runs-on: windows-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          cache-targets: true
      - name: Build binaries
        run: cargo build --release --workspace
        shell: pwsh
      - name: Package artifacts
        run: |
          Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path dist | Out-Null
          Copy-Item target\release\obsidian-links.exe dist\
          Copy-Item target\release\obsidian-tags.exe dist\
          if (Test-Path obsidian-utils-windows-x86_64.zip) { Remove-Item obsidian-utils-windows-x86_64.zip }
          Compress-Archive -Path dist\* -DestinationPath obsidian-utils-windows-x86_64.zip
        shell: pwsh
      - name: Upload artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: obsidian-utils-windows-x86_64
          path: obsidian-utils-windows-x86_64.zip

  release:
    needs:
      - build-linux
      - build-macos-arm64
      - build-windows-x86_64
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          merge-multiple: true
      - name: Create GitHub release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          files: |
            obsidian-utils-linux-x86_64.tar.gz
            obsidian-utils-linux-arm64.tar.gz
            obsidian-utils-macos-arm64.tar.gz
            obsidian-utils-windows-x86_64.zip

# TODO: canary releases on push to master
